\section{Diffusion matrices from algebraic geometry codes}
\label{matt}

We now discuss how to design diffusion matrices based on the code from \autoref{ex:genus2} of \autoref{sec:ag}
with efficient implementations with respect to \autoref{alg:shuffle} of the previous section.

A diffusion matrix associated to this code is simply the right block $A$ of a generator matrix in systematic form $G \defas (I_{16}~A)$.
Recall that $G$ is the result of computing the reduced row-echelon form of the matrix obtained by evaluating a basis for $\funcspace$
on $\points$. Using the row-echelon form is simply a convenient way of computing the basis that results in $G$ being in systematic
form, so it is clear that the initial choice of the basis for $\funcspace$ prior reduction does not impact $G$, and hence $A$.
However, changing the order of the elements of the evaluation domain does result in different matrices.

The problem for the rest of the section is thus to find good orderings $\points$,
that result in matrices with a low cost, \ie efficient \emph{encoders}, that is implementations of a generator matrix.
For simplicity, we write $\cagh$ to denote any code obtained from \autoref{ex:genus2}, with the precise choice of the evaluation domain thus $\points$ left unspecified.


\subsection{Compact encoders using code automorphisms}
\label{sec:autos}

Our first objective is to find matrices obtained from $\cagh$ that can be generated by permutations of a small number of rows.
The main tool we use to achieve this goal are \emph{automorphisms} of $\cagh$; these are the injective morphisms from the code to itself.
\begin{defi}[Automorphism of a code]
The automorphism group $\aut(\mathcal{C})$ of a code $\mathcal{C}$ of length $n$ is a subgroup of $\mathfrak{S}_n$ such that
$\pi \in \aut(\mathcal{C}) \Leftrightarrow (c \in \mathcal{C} \Rightarrow \pi(c) \in \mathcal{C})$.
\end{defi}

As $\cagh$ is an evaluation code, we can equivalently define its automorphisms as being permutations of the elements of $\points$.
If $\pi$ is an automorphism of $\cagh$, if $\{O_0, \ldots, O_\ell\}$ are its orbits, and if our instance of the code
has an evaluation support s.t. elements of a same orbit are consecutive,
then the action of $\pi$ on a codeword of $\cagh$
is to cyclically permute its coordinates locally, along each orbit.

To see that this can be useful, assume that there is an automorphism $\pi$ with two orbits $O_0$ and $O_1$ of size $n/2$ each. Then, if $\mat \defas (I_{n/2}~A)$ is
built from $\points \defas (O_0, O_1)$, each row of $\mat$ can be obtained by the repeated action of $\pi$ on, say, $\mat_0$, and it follows
that $A$ is circulant and therefore has a low cost w.r.t. \autoref{alg:shuffle}. More generally, if an automorphism can be found such that it has orbits of sizes summing up to
$n/2$, and if the two partitions defined by the orbits have maximal rank, then the corresponding matrix $\mat$ can be deduced from a small set of rows. We give two toy examples with Reed-Solomon codes, which can easily be verified.

\paragraph{$\pi:~\Fst \rightarrow \Fst,~x \mapsto 8 x$.} This automorphism has $O_0\defas (1, 8, 12, 10, 15)$
and $O_1 \defas (2, 3, 11, 7, 13)$ for orbits, among others. The systematic matrix for the $[10, 5, 6]_{\Fst}$ code obtained with the points in that
order is then such that $A$ is circulant and obtained from the cyclic permutation of the row $(12, 10, 2, 6, 3)$.

\paragraph{$\pi:~\Fst \rightarrow \Fst,~x \mapsto 7 x$.} This automorphism has $O_0 \defas (1, 7, 6)$,
$O_1 \defas (2, 14, 12)$, $O_2 \defas (4, 15, 11)$, and $O_3 \defas (8, 13, 5)$ for orbits, among others.
The systematic matrix for the $[12, 6, 7]_{\Fst}$ code obtained with the points in that
order is then of the form
$\begin{pmatrix}
	I_3 & 0_3 & A & B \\
	0_3 & I_3 & C & D\\
\end{pmatrix}$ with $A$, $B$, $C$ and $D$ circulant matrices. It can thus be obtained by cyclic permutation of only two rows.

\medskip

\subsubsection{Application to $\cagh$.}
Automorphisms of $\cagh$ may be quite harder to find than ones of RS codes. They can however
be found within automorphisms of the curve $\curve$ on which it is based~\cite{stichtenoth}, or rather its function field. This is quite intuitive, as these will precisely permute
places of the curve, which are the elements on which the code is defined. We mostly need to be careful to only use automorphisms that fix the places of the divisor
$D$ used to define $\funcspace$. In our case, this means fixing the place at infinity.

We considered the degree-one automorphisms of the curve $\curve$ of \autoref{ex:genus2}, for instance described
by Duursma~\cite{duursma}. They have two generators: $\pi_0:~\Fst^2 \rightarrow \Fst^2,~(x, y) \mapsto (\zeta x, y)$ with $\zeta^5 = 1$, and
$\pi_{1_{(a,b)}}:~\Fst^2 \rightarrow \Fst^2,~(x, y) \mapsto (x + a, y + a^8 x^2 + a^4 x + b^4)$, with $(a, b)$ an affine point of $\curve$.
These generators span a group of order 160.
When considering their orbit decomposition, the break-up of the size of the orbits can only be of one of five types, given
in \autoref{tbl:orbits}.

\begin{table}[!h]
\caption[Possible combination of orbit sizes of automorphisms of $\cagh$ spanned by $\pi_0$ and $\pi_1$.]{Possible combination of orbit sizes of automorphisms of $\cagh$ spanned by $\pi_0$ and $\pi_1$.
A number $n$ in column $c$ means that an automorphism of this type has $n$ orbits of size $c$.
\label{tbl:orbits}}
\begin{center}
%\begin{tabularx}{\textwidth}{ X  X  X  X  X  X}
\begin{tabular}{ l  c  c  c  c  c}
\toprule
 Orbit size & 1 & 2 & 4 & 5 & 10 \\
\midrule
Type 1 & 32 & 0 & 0 & 0 & 0\\

Type 2 & 0 & 16 & 0 & 0 & 0\\

Type 3 & 0 & 0 & 8 & 0 & 0\\

Type 4 & 2 & 0 & 0 & 6 & 0\\

Type 5 & 0 & 1 & 0 & 0 & 3\\
\bottomrule
\end{tabular}
\end{center}
\end{table}
\noindent
From these automorphisms, it is possible to define partitions of $\points$ in two sets of size sixteen which are union of orbits. We may therefore
hope to obtain systematic matrices of the type we are looking for. Unfortunately, after an extensive search both on $\cagh$ and
on the smaller elliptic code of \autoref{ex:genus1} using its own automorphisms, it appears that ordering $\points$ in this fashion \emph{never} results in
obtaining a systematic matrix, \ie computing the row-reduced of the initial matrix never results in a left square submatrix of full rank.

\subsubsection{Extending the automorphisms with the Frobenius mapping.} We extend the previous automorphisms with the
Frobenius mapping $\frob:~\Fst^2 \rightarrow \Fst^2,\linebreak(x, y) \mapsto (x^2,y^2)$; this adds another 160 ``automorphisms'' for $\curve$. However, these will not anymore be
automorphisms for the \emph{code} $\cagh$ in general, and we will therefore obtain matrices of a form slightly different from what we first hoped to achieve.

The global strategy is still the same, however, and consists in ordering the points along orbits of the curve automorphisms.
By using the Frobenius, we can obtain new combination of orbit sizes, notably four of size eight.
We study below the result of ordering $\points$
along the orbits of one such automorphism. We take the example of $\sigma \defas \frob \circ \sigma_2 \circ \sigma_1$, with
$\sigma_1 : (x,y) \mapsto (x + 1, y + x^2 + x + 7)$ and
$\sigma_2 : (x,y) \mapsto (12x, y)$. An observation is that in this case, only $\sigma^0$ and $\sigma^4$ are automorphisms of $\cagh$.
Note that not all orbits orderings of $\sigma$ for $\points$ yield a systematic matrix. However, unlike as above, we were able to find some orders
that do. In these cases, the right matrix ``$A$'' of the full generator matrix $(I_{16}~A)$ is of the form:
\[
\begin{aligned}
(A_0, A_1, A_2, A_3, \sigma^4(A_0), \sigma^4(A_1), \sigma^4(A_2), \sigma^4(A_3),\\
A_8, A_9, A_{10}, A_{11}, \sigma^4(A_8), \sigma^4(A_9), \sigma^4(A_{10}), \sigma^4(A_{11})),
\end{aligned}
\]
with $A_0,\ldots, A_3$, $A_8,\ldots, A_{11}$ row vectors of dimension 16. For instance, the first and fifth row of one such matrix are:
\[
	\begin{aligned}
	A_0 =(5, 2, 1, 3, \mathbf{8, 5, 1, 5}, 12, 10, 14, 6, \mathbf{7, 11, 4, 11})\\
	A_4 = \sigma^4(A_0) = (\mathbf{8, 5, 1, 5}, 5, 2, 1, 3, \mathbf{7, 11, 4, 11}, 12, 10, 14, 6).
	\end{aligned}
\]
We give the full matrix corresponding to these rows in \autoref{fig:matblock}.

We have therefore partially reached our goal of being able to describe $A$ from a permutation of a subset of its rows. However this subset
is not small, as it is of size 8 ---half
of the matrix dimension. Consequently, these matrices have a moderate cost according to the $\cost$ function, when implemented with \autoref{alg:shuffle}, but it is not minimal. Interestingly, all the matrices of this form
that we found have the same cost of 52.

\subsection{Fast random encoders}

We conclude this section by presenting the results of a very simple random search for efficient encoders of $\cagh$ with respect to \autoref{alg:shuffle}. Unlike
in the above discussion, this search does not exploit any kind of algebraic structure.
Indeed, it only consists in repeatedly generating a random permutation of the affine points of the curve, building
a matrix for the code with the corresponding point order, tentatively putting it in systematic form $(I_{16}~A)$, and if successful evaluating
the $\cost$ function from \autoref{shuff} on $A$. We then collect matrices with a minimum cost.

Because there are $32! \approx 2^{117.7}$ possible point orders, we can only explore a very small part of the search space. However,
matrices of low cost can be found even after a moderate amount of computation, and we found many matrices of
cost 43, though none of a lower cost. We present in \autoref{tbl:randomsearch} from \autoref{app:stats} the number of matrices of cost strictly less than 60
that we found during a search of $2^{38}$ encoders.
We give an example of a matrix of cost 43 in \autoref{fig:matrand}, which is only about a factor 1.7 away from the estimate of the minimum cost of a circulant matrix
given in \autoref{shuff}. We observe that the transpose of this matrix, \ie its inverse, also has a cost of 43.
